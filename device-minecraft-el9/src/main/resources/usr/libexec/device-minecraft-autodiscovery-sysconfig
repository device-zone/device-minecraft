#!/bin/bash

if [ $# -eq 2 ]; then

  instance="${1}"
  line="${2}"

  if test ! -f "$line/port.txt"; then
    port=25565
  else
    port=$(head -n 1 "$line/port.txt")
  fi

  preferences=""
  if test -f "$line/protocol.txt"; then
    protocol="$(head -n 1 $line/protocol.txt)"
    if test "${protocol}" == "prefer-ipv4"; then
      preferences="-Djava.net.preferIPV4stack=true -Djava.net.preferIPv6Addresses=false"
    elif test "${protocol}" == "prefer-ipv6"; then
      preferences="-Djava.net.preferIPV4stack=false -Djava.net.preferIPv6Addresses=true"
    fi
  fi

  cat >> "minecraft-${instance}" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

MINECRAFT_OPTS="--nogui --port ${port}"
JAVA_OPTS="${preferences} -Dhttp.proxyHost=regentstreet.naw.pepperpot.media -Dhttp.proxyPort=3128 -Dhttps.proxyHost=regentstreet.naw.pepperpot.media -Dhttps.proxyPort=3128 -Xmx1024M -Xms512M"

EOF

  install -m 640 "minecraft-${instance}" "/etc/sysconfig/minecraft-${instance}"

fi

